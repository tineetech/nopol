<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Multi-Sheet CRUD</title>
    <style>
        body { font-family: sans-serif; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <h1>Pilih Sheet & CRUD</h1>
    <div>
        <button onclick="changeSheet('UNIT')">Lihat Data Unit</button>
        <button onclick="changeSheet('ACTIVITY')">Lihat Data Activity</button>
    </div>
    
    <hr>

    <h2 id="currentSheetName">Data Sheet: UNIT</h2>
    
    <h3>Form Tambah Data</h3>
    <form id="dataForm">
        </form>
    
    <hr>
    
    <h3>Data dari Google Sheets</h3>
    <table border="1" id="dataTable">
        <thead>
            </thead>
        <tbody>
            </tbody>
    </table>

    <script>
        const webAppUrl = "https://script.google.com/macros/s/AKfycbwoUJFOjUBS-uE2SCiwRH2m5ApczVQvUs-qBrRvfkeb96OnI8wEV1300-teTpkzPNvH/exec";
        const dataForm = document.getElementById('dataForm');
        const dataTable = document.getElementById('dataTable');
        const dataTableHead = dataTable.querySelector('thead');
        const dataTableBody = dataTable.querySelector('tbody');
        const currentSheetNameElement = document.getElementById('currentSheetName');
        let currentSheet = 'UNIT'; // Sheet yang sedang aktif

        // Definisi struktur kolom untuk setiap sheet
        const sheetsConfig = {
            'UNIT': ['BAYS', 'NOPOL', 'IN', 'OUT', 'NEW/REC', 'TYPE UNIT', 'YEAR', 'MODEL UNIT', 'AXLE', 'SITE', 'CLIENT', 'NOTE'],
            'ACTIVITY': ['Tanggal', 'Unit', 'Aktivitas', 'Lokasi', 'Status']
        };

        // Fungsi untuk mengganti sheet yang ditampilkan
        function changeSheet(sheetName) {
            currentSheet = sheetName;
            currentSheetNameElement.textContent = `Data Sheet: ${currentSheet}`;
            renderFormAndTable();
            fetchData();
        }

        // Fungsi untuk me-render form dan header tabel sesuai sheet
        function renderFormAndTable() {
            const headers = sheetsConfig[currentSheet];
            
            // Render Form
            dataForm.innerHTML = '';
            headers.forEach(header => {
                const label = document.createElement('label');
                label.htmlFor = header.replace(/\s/g, '');
                label.textContent = `${header}:`;
                
                const input = document.createElement('input');
                input.type = 'text';
                input.id = header.replace(/\s/g, '');
                // input.required = true;

                dataForm.appendChild(label);
                dataForm.appendChild(input);
                dataForm.appendChild(document.createElement('br'));
                dataForm.appendChild(document.createElement('br'));
            });
            const submitButton = document.createElement('button');
            submitButton.type = 'submit';
            submitButton.textContent = 'Tambah Data';
            dataForm.appendChild(submitButton);

            // Render Table Header
            dataTableHead.innerHTML = '';
            const headerRow = document.createElement('tr');
            headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                headerRow.appendChild(th);
            });
            const actionTh = document.createElement('th');
            actionTh.textContent = 'Aksi';
            headerRow.appendChild(actionTh);
            dataTableHead.appendChild(headerRow);
        }

        // Fungsi untuk mengambil data (READ)
        async function fetchData() {
            try {
                const response = await fetch(`${webAppUrl}?sheet=${currentSheet}`);
                const data = await response.json();
                console.log(data)
                renderTable(data);
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }

        // Fungsi untuk menampilkan data ke tabel
        function renderTable(data) {
            dataTableBody.innerHTML = '';
            const headers = sheetsConfig[currentSheet];
            data.forEach((row, index) => {
                const tr = document.createElement('tr');
                headers.forEach(header => {
                    const td = document.createElement('td');
                    td.textContent = row[header] ?? '-';
                    tr.appendChild(td);
                });
                tr.innerHTML += `
                    <td>
                        <button onclick="updateData(${index + 2})">Update</button>
                        <button onclick="deleteData(${index + 2})">Delete</button>
                    </td>
                `;
                dataTableBody.appendChild(tr);
            });
        }

        // Menangani submit form (CREATE)
        dataForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const headers = sheetsConfig[currentSheet];
            const payloadArray = headers.map(header => {
                const inputId = header.replace(/\s/g, '');
                return document.getElementById(inputId).value;
            });
            
            const payload = {
                sheet: currentSheet,
                action: 'create',
                payload: payloadArray
            };
            
            await postData(payload);
            fetchData();
        });

        // Fungsi untuk mengupdate data (UPDATE)
        async function updateData(row) {
            const headers = sheetsConfig[currentSheet];
            const newPayload = {};
            let hasNewData = false;
            
            headers.forEach(header => {
                const newValue = prompt(`Masukkan ${header} baru:`);
                if (newValue !== null) {
                    newPayload[header] = newValue;
                    hasNewData = true;
                }
            });
            
            if (hasNewData) {
                const payload = {
                    sheet: currentSheet,
                    action: 'update',
                    row: row,
                    payload: newPayload
                };
                await postData(payload);
                fetchData();
            }
        }

        // Fungsi untuk menghapus data (DELETE)
        async function deleteData(row) {
            if (confirm('Yakin ingin menghapus data ini?')) {
                const payload = {
                    sheet: currentSheet,
                    action: 'delete',
                    row: row
                };
                await postData(payload);
                fetchData();
            }
        }

        // Fungsi helper untuk mengirim permintaan POST
        async function postData(payload) {
            try {
                const response = await fetch(webAppUrl, {
                    method: 'POST',
                    body: JSON.stringify(payload),
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8'
                    }
                });
                const result = await response.json();
                alert(result.message);
            } catch (error) {
                console.error('Error posting data:', error);
            }
        }

        // Jalankan saat halaman dimuat
        renderFormAndTable();
        fetchData();
    </script>
</body>
</html>